---
title: Profile of patients triaged green in the Emergency Department (ED) of a secondary care hospital in Mumbai
author: "Anna"
date: "12/05/2020"
csl: american-medical-association.csl
link-citations: yes
output:
  bookdown::word_document2: default
  bookdown::html_document2:
    number_sections: false
  bookdown::pdf_document2:
    number_sections: false
    toc: false
    keep_tex: yes
bibliography: abstract.bib
---

```{r setup, include=FALSE, results='asis', message=FALSE}
library(knitr)
library(dplyr)
library(psych)
library(data.table) 
library(tableone)
library(epiDisplay)
library(tigerstats)
library(splitstackshape)
library(tidyverse)
library(tidyr)
library(assertthat)
library(rlist)
library(labelled)
library(corrplot)
library(DiagrammeR) #For the flowchart
library(DiagrammeRsvg) #Exporting the flowchart as svg
library(magrittr) #Exporting the flowchart as svg
library(rsvg) #Exporting the flowchart as svg
knitr::opts_chunk$set(echo = FALSE)
```


```{r Data_cleaning_manipulation, warning=FALSE, results='hide'}

# Get data directory

data.dir <- getOption("data.dir")
options(data.dir = "C:/Users/annan/OneDrive/Documents/Projects/PGTP")
if (is.null(data.dir))
    stop ("Please set the directory where the data is kept using options(data.dir = \"<path to data directory>\")")

## datatable with ISS
g <- data.table::fread(file.path(data.dir,"ttris-dataset-with-iss-8317-20190708120045.csv"))
g1 <- g %>% dplyr::select(pid,X0:iss)

## datatable without ISS
h <- data.table::fread(file.path(data.dir, "TTRIS.csv"))

## Merged the two datatables
h$pid <- as.integer(h$pid)
dt <- merge(g1, h, by = "pid")

## Rearranging columns
dt <- dt %>% dplyr::select(centre,pid,cr,qcrec:vsqs,ic:toa,egcs:rr,nsi,tc,dvsr:tvsr,dus:testvar,locked,X0:iss,doi_toi:valid)

#dplyr::all_equal(g,dt) ##To compare the two dataframes

# Creating age groups
agebreaks <- c(17,25,45,65,98)
agelabels <- c("18-24","25-44","45-64","65+")
dt$agegrp <-cut(dt$age,
                breaks = agebreaks,
                right = FALSE,
                labels = agelabels)

# Mechanism of Injury
moi.collapsed <- moi <- as.character(dt$moi)

get_icd_range <- function(first.char, start.number, end.number) {
    icd.range <- paste0(
        paste0(
            "^",
            first.char,
            stringr::str_pad(start.number:end.number, 2, pad = "0"),
            "[0-9]?$"),
        collapse = "|")
    return (icd.range)
}

icd.ranges <- list(c("Transport accident" = get_icd_range("V", 0, 99)),
                   c("Fall" = get_icd_range("W", 0, 19)),
                   c("Animal bite" = get_icd_range("W", 50, 64)),
                   c("Assault" = paste0(get_icd_range("X", 85, 99), "|", get_icd_range("Y", 0, 9))))

for(icd.range in icd.ranges) moi.collapsed[grep(icd.range, moi)] <- names(icd.range)
moi.collapsed[!(moi.collapsed %in% sapply(icd.ranges, attr, "names"))] <- "Other"
dt$moi.collapsed <- as.factor(moi.collapsed)

# Correcting ISS
dt <- as_tibble(dt)
ais <- dt %>% dplyr:: select(starts_with("clean_"))

ais.list <- lapply(names(ais), function(x) cSplit(ais[, x], x, sep = ","))
row_max <- function(x, na.rm = FALSE) {
    if (all(is.na(x)))
        return (NA)
    max(x, na.rm = na.rm)
}
ais.max <- lapply(ais.list, function(x) apply(x, 1, row_max, na.rm = TRUE))
get_top_3 <- function(x) {
    x <- sort(x, decreasing = TRUE, na.last = TRUE)
    i <- min(c(3, length(x)))
    x[seq_len(i)]
}
calculate_iss <- function(x) {
    top3 <- get_top_3(x)
    iss <- sum(top3[1]^2, top3[2]^2, top3[3]^2, na.rm = TRUE)
    if (all(is.na(top3)))
        iss <- NA
    iss
}
iss <- apply(do.call(cbind, ais.max), 1, calculate_iss)
iss[is.na(iss)] <- "0"

dt$iss <- as.numeric(iss)

## Note that these operations do not work as intended because iss is
## character, not numeric

issbreaks <- c(0,1,9,16,25,109)
isslabels <- c("No defined injury","Mild","Moderate","Severe","Profound")
dt$isspv <-cut(dt$iss,
                breaks = issbreaks,
                right = FALSE,
                labels = isslabels)

# Append a new variable 'GCS' to the dataset
gcs <- with(dt, egcs + vgcs + mgcs)
dt$gcs <- gcs <- replace(gcs, gcs > 15, NA)

dt$gcs.cat <- gcs
dt$gcs.cat[gcs >= 13] <- "Mild"
dt$gcs.cat[gcs >= 9 & gcs < 13] <- "Moderate"
dt$gcs.cat[gcs >= 3 & gcs < 9] <- "Severe"

##Assigning parameter value for calculating RTS. 

gcspv <- gcs
gcspv[gcs >= 13] <- 4
gcspv[gcs >= 9 & gcs < 13] <- 3
gcspv[gcs >= 6 & gcs < 9] <- 2
gcspv[gcs >= 4 & gcs < 6] <- 1
gcspv[gcs < 4] <- 0

## RR parameter value for calculating RTS
rr <- with(dt,replace(rr, rr == 999, NA))
rrpv <- rr

rrpv[rr >= 10 & rr <= 29] = 4
rrpv[rr > 29] = 3
rrpv[rr >= 6 & rr <= 9] = 2
rrpv[rr >= 1 & rr <= 5] = 1
rrpv[rr == 0] = 0

## SBP parameter value for calculating RTS
sbp <- with(dt,replace(sbp, sbp == 999, NA))
sbppv <- sbp

sbppv[sbp > 89] <- 4
sbppv[sbp >=76 & sbp <= 89] <- 3
sbppv[sbp >= 50 & sbp <= 75] <- 2
sbppv[sbp >= 1 & sbp <= 49] <- 1
sbppv[sbp == 0] <- 0

## Formula for calculating RTS

dt$rts = round(0.9368*as.numeric(gcspv) + 
               0.7326*as.numeric(sbppv) + 
               0.2908*as.numeric(rrpv), digits = 0)

# Complete case analysis
dt$s24h <- replace(dt$s24h, dt$s24h == 999, 888) ##Loss of follow up 
dt$s30d <- replace(dt$s30d, dt$s30d == 999, 888)
dt$s6m <- replace(dt$s6m, dt$s6m == 999, 888)
dt$s <- replace(dt$s, dt$s == 999, 888)

## Converting all Injury 999 to Not Defined
inj_cols <- dt[,grep("inj", colnames(dt))]

inj_cols <- inj_cols %>% 
    mutate_all(funs(str_replace(., "999", "ND")))

dt[,grep("inj", colnames(dt))] <- inj_cols

## Converting NA to ND in max cols
#dt %>% dplyr:: select(starts_with("max_")) %>% 
#    mutate_all(funs(str_replace(., "NA", "ND")))

## Dropping unwanted columns
drop.cols2 <- dt %>% dplyr:: select(starts_with("clean_"), starts_with("max_"), qcrec, vsqs, testvar, locked, X0)

drop.cols2 <- colnames(drop.cols2)

dt <- dt[, !(colnames(dt) %in% c(drop.cols2))]

## Converting rest of the 999s to NA
dt[] <- dt[] %>% 
    mutate_all(funs(na_if(.,"999")))

missing.data.list <- lapply(dt, function(column) {
    n.na <- sum(is.na(column))
    p.na <- round((n.na/length(column)) * 100)
    missing <- data.frame("Count" = n.na, "Percentage" = p.na)
    return (missing)
})

missing.data <- do.call(rbind, missing.data.list)

maximum.missing <- rownames(missing.data)[missing.data$Count == max(missing.data$Count)]

complete.index <- complete.cases(dt)
n.incomplete <- sum(!complete.index)
p.incomplete <- round((n.incomplete/nrow(dt)) * 100,1)

dt <- dt[complete.index, ]
n_nic <- nrow(subset(x=dt, subset = dt$ic == 0))
dt <- subset(x=dt,subset = dt$ic == 1)

# Grouping patients wrt to injury

#if (substr(kbbh$einj1icd,start=3, stop=3) == 1) {"Open Wound"}

dt <- suppressWarnings(suppressMessages(unite(dt, allinj, contains("icd"), sep = ",", remove = FALSE)))

crush_inj <- str_c(c("S07","S070","S071","S078","S079","S17","S170","S178","S179","S280","S380","S381","T041","S47","S57","S570","S578","S579","S67","S670","S678","T042","S770","S771","S772","S87","S870","S878","S97","S970","S971","S978","T043","T048","T049"),collapse = "|")

#mutate(kbbh$inj_type = case_when(kbbh, str_detect(allinj, crush_inj)~Crush Injury))
crush <- filter(dt, str_detect(allinj, crush_inj))
crush$inj_type <- "Crush Injury"
rest <- suppressWarnings(suppressMessages(dt %>% anti_join(crush)))

#table(crush$allinj)

internal_inj <- str_c(c("S06","S060","S061","S062","S063","S064","S065","S066","S067","S068","S069","T905","S140","S141","S240","S241","S340","S341","S343","T093","T913","S142","S260","S270","S271","S272","S273","S274","S275","S276","S278","S279","T914","S36","S360","S361","S362","S363","S364","S365","S366","S367","S368","S369","S37","S370","S371","S372","S373","S374","S375","S376","S377","S378","S379","S396","S397","T065","T915"),collapse = "|")

internal <- filter(rest, str_detect(allinj, internal_inj))
internal$inj_type <- "Internal Injury"
rest <- suppressWarnings(suppressMessages(rest %>% anti_join(internal)))

bv_inj <- str_c(c("S090","S150","S512","S153","S154","S155","S156","S157","S158","S159","S151","S25","S250","S251","S252","S253","S254","S255","S257","S258","S259","S350","S351","S352","S353","S354","S355","S357","S358","S359","S45","S450","S451","S452","S453","S457","S458","S459","S55","S550","S551","S552","S557","S558","S559","S65","S650","S651","S652","S653","S654","S655","S657","S658","S659","T114","S75","S750","S751","S752","S757","S758","S759","S85","S850","S851","S852","S853","S854","S855","S857","S858","S859","S95","S950","S951","S952","S957","S958","S959","T134","T063","T145"),collapse = "|")

bv <- filter(rest, str_detect(allinj, bv_inj))
bv$inj_type <- "Blood Vessel"
rest <- suppressWarnings(suppressMessages(rest %>% anti_join(bv)))

amp_inj <- str_c(c("S08","S081","S082","S083","S084","S085","S086","S087","S088","S089","S18","S281","S382","S383","T096","S48","S480","S481","S489","S58","S580","S581","S589","S68","S680","S681","S682","S683","S684","S688","S689","T050","T052","T116","S780","S781","S782","S783","S784","S785","S786","S787","S788","S789","S88","S880","S881","S889","S98","S980","S981","S982","S983","S984","S780","T053","T055","T136","T058","T059"),collapse = "|")

amputation <- filter(rest, str_detect(allinj, amp_inj))
amputation$inj_type <- "Amputation"
rest <- suppressWarnings(suppressMessages(rest %>% anti_join(amputation)))

#table(amputation$allinj)

frac_inj <- str_c(c("S02","S020","S021","S023","S027","S029","T902","S022","S024","S025","S026","S12","S128","S129","S120","S121","S122","S123","S124","S125","S126","S127","S22","S220","S221","S32","S320","S321","S322","T08","T911","S222","S223","S224","S225","S226","S227","S228","S229","S323","S324","S325","S326","S327","S328","T021","T912","S42","S420","S421","S422","S423","S424","S427","S428","S429","S52","S520","S521","S522","S523","S524","S525","S526","S527","S528","S529","S62","S620","S621","S622","S623","S624","S625","S626","S627","S628","T022","T024","T10","T921","T922","S72","S720","S721","S722","S723","S724","S725","S726","S727","S728","S729","S82","S820","S821","S822","S823","S824","S825","S826","S827","S828","S829","S92","S920","S921","S922","S923","S924","S925","S927","S929","T023","T025","T12","T931","T932","T028","T029","T142"),collapse = "|")

frac <- filter(rest, str_detect(allinj, frac_inj))
frac$inj_type <- "Fracture"
rest <- suppressWarnings(suppressMessages(rest %>% anti_join(frac)))

#table(frac$allinj)

disl_inj <- str_c(c("S030","S031","S032","S033","S130","S131","S132","S133","S230","S231","S330","S331","S332","S232","S333","S334","S430","S431","S432","S433","S530","S531","S630","S631","S632","S730","S830","S831","S93","S930","S931","S933"),collapse = "|")
disl <- filter(rest, str_detect(allinj, disl_inj))
disl$inj_type <- "Dislocation"
rest <- suppressWarnings(suppressMessages(rest %>% anti_join(disl)))

burn_inj <- str_c(c("T26","T260","T261","T262","T263","T264","T265","T266","T267","T268","T269","T270","T274","T20","T200","T201","T202","T203","T204","T205","T206","T207","T280","T285","T950","T281","T286","T283","T288","T21","T211","T212","T213","T214","T215","T216","T217","T272","T273","T276","T277","T282","T287","T951","T22","T220","T221","T222","T223","T224","T225","T226","T227","T23","T230","T231","T232","T233","T234","T235","T236","T237","T952","T24","T240","T241","T242","T243","T244","T245","T246","T247","T25","T250","T251","T252","T253","T254","T255","T256","T257","T271","T275","T289","T284","T29","T290","T291","T292","T293","T294","T295","T296","T297","T30","T300","T301","T302","T303","T304","T305","T306","T307","T32","T320","T321","T322","T323","T324","T325","T326","T327","T328","T329","T954","T958","T959"),collapse = "|")

burn <- filter(rest, str_detect(allinj, burn_inj))
burn$inj_type <- "Burn"
rest <- suppressWarnings(suppressMessages(rest %>% anti_join(burn)))

multiple_inj <- str_c(c("S097","S197","S277","S297","T031","T092","S497","S597","S697","T032","T112","T923","T926","S797","S897","S997","T033","T132","T933","T936","T038","T039","T910","T143","T147"),collapse = "|")

multiple <- filter(rest, str_detect(allinj, multiple_inj))
multiple$inj_type <- "Multiple Injuries"
rest <- suppressWarnings(suppressMessages(rest %>% anti_join(multiple)))

unspe_inj <- str_c(c("S099","T909","S059","S199","S269","S299","S399","T099","S499","S599","S699","T119","T929","S799","S837","S899","S999","T139","T939","T07","T919","T940","T148","T149","T941","T981"),collapse = "|")

unspe <- filter(rest, str_detect(allinj, unspe_inj))
unspe$inj_type <- "Unspecified Injury"
rest <- suppressWarnings(suppressMessages(rest %>% anti_join(unspe)))

open_inj <- str_c(c("S01","S010","S011","S012","S013","S014","S015","S017","S018","S019","T901","S052","S053","S054","S055","S056","S057","S080","S092","S11","S110","S111","S112","S117","S118","S119","S21","S210","S211","S212","S217","S218","S219","S311","S318","S310","S312","S313","S314","S315","S317","T091","S41","S410","S411","S417","S418","S51","S510","S517","S518","S519","S61","S610","S611","S617","S618","S619","T012","T111","T920","S710","S711","S712","S713","S714","S715","S716","S717","S718","S81","S810","S817","S818","S819","S91","S910","S911","S912","S913","S917","T013","T131","T930","T019","T141"),collapse = "|")

open <- filter(rest, str_detect(allinj, open_inj))
open$inj_type <- "Open wound"
rest <- suppressWarnings(suppressMessages(rest %>% anti_join(open)))

supf_inj <- str_c(c("S00","S000","S001","S002","S003","S004","S005","S007","S008","S009","S050","S051","T900","S10","S100","S101","S107","S108","S109","S20","S200","S201","S202","S203","S204","S207","S208","S301","S300","S302","S307","S308","S309","T090","S40","S400","S407","S408","S409","S50","S500","S501","S507","S508","S509","S60","S600","S601","S602","S607","S608","S609","T002","T110","S70","S700","S701","S702","S703","S704","S705","S706","S707","S708","S709","S80","S800","S801","S807","S808","S809","S90","S900","S901","S902","S903","S907","S908","S909","T003","T130","T008","T009","T140","T150"),collapse = "|")

supf <- filter(rest, str_detect(allinj, supf_inj))
supf$inj_type <- "Superficial Injury"
no_def_inj <- suppressWarnings(suppressMessages(rest %>% anti_join(supf)))
no_def_inj$inj_type <- "No defined Injury"
dt <- suppressWarnings(suppressMessages(rbind(no_def_inj,supf,open,unspe,multiple,burn,disl,frac,amputation,bv,internal,crush)))

# Time spent in ED
dt$admits <- ifelse(dt$doa==0 & dt$daicu==0,"Not admitted","Admitted")

nap <- subset(dt,dt$admits=="Not admitted")
ardd.time <- round(difftime(paste(nap$dodd , nap$todd),paste(nap$doar, nap$toar), units = "hours"))
nap$ardd <- if_else(ardd.time<2,"0-1",
                    ifelse(ardd.time<3,"1-2",">2"))

nnap <- subset(dt,dt$admits=="Admitted")
nardd.time <- round(difftime(paste(nnap$doa , nnap$toa),paste(nnap$doar, nnap$toar), units = "hours"))
nnap$ardd <- if_else(nardd.time<2,"0-1",
                    ifelse(nardd.time<3,"1-2",">2"))

dt <- suppressWarnings(suppressMessages(rbind(nap,nnap)))
#kbbh<- merge(kbbh,kbbh.temp)
dt$ardd <- as.factor(dt$ardd)

# Time difference between injury and arrival

start.time <- paste(dt$doi, dt$toi)
end.time <- paste(dt$doar, dt$toar)
injar.time <- round(difftime(end.time,start.time, units = "hours"),0)
dt$inj_arr <- ifelse(injar.time<2,"0-1",">1")

#Calculation of CTS

##TEWS



rr<-  as.numeric(dt$rr)

dt$rrt <- if_else(rr >= 30,"3",
               if_else(rr>=21 & rr <= 29,"2",
                       if_else(rr>=15 & rr <= 20,"1",
                               if_else(rr>=9 & rr <= 14,"0","2"))))

sbp <- as.numeric(dt$sbp)

dt$sbpt <- if_else(sbp <= 70, "3",
                if_else(sbp>=200,"2",
                        if_else(sbp>=71 & sbp<=80,"2",
                                if_else(sbp >= 81 & sbp <= 100,"1","0"))))

hr <- dt$hr

dt$hrt <- if_else(hr >= 130, "3",
               if_else(hr >= 111 & hr <= 129, "2",
                       if_else(hr <= 40,"2",
                               if_else(hr >= 101 & hr <=110,"1",
                                       if_else(hr>=41 &hr <=50,"1","0")))))

avpu <- dt$avpu

dt$avput <- if_else(avpu == 0, "3",
                    if_else(avpu == 1, "2",
                            if_else(avpu == 2, "1","0")))

tews <- round(as.numeric(dt$avput)+
                  as.numeric(dt$rrt)+
                  as.numeric(dt$sbpt)+
                  as.numeric(dt$hrt)+ 1, 0)  #Trauma


#TEWS cts

dt$tews_cts <- tews_cts <- tews

tews_cts[tews >=0 & tews <=2] <- "Green"
tews_cts[tews >=3 & tews <=5] <- "Yellow"
tews_cts[tews >=6 & tews <=7] <- "Orange"
tews_cts[tews >7] <- "Red"

dt$tews_cts <- tews_cts

# AVPU cts

avpu_cts <- dttt$cts

avpu_cts[avpu == 0] <- "Red"
avpu_cts[avpu == 1] <- "Orange"
avpu_cts[avpu == 2] <- "Yellow"
avpu_cts[avpu == 3] <- "Green"

dt$avpu_cts <- avpu_cts

#Burn CTS

allinj <- dt$allinj

burn_internal_inj <- str_c(c("T26","T260","T261","T262","T263","T264","T265","T266","T267","T268","T269","T27","T270","T271","T272","T273","T274","T275","T276","T277","T28","T280","T281","T282","T283","T284","T285","T286","T287","T288","T289","T203","T207","T213","T217","T223","T227","T233","T237","T243","T247","T253","T257","T293","T297","T303","T307","T312","T313","T314","T315","T316","T317","T318","T319","T322","T323","T324","T325","T326","T327"),collapse = "|")

burn_face <- str_c(c("T20","T200","T201","T202","T204","T205","T206"),collapse="|")

burn_rest <- str_c(c("T21","T210","T211","T212","T214","T215","T216","T22","T220","T221","T222","T224","T225","T226","T23","T230","T231","T232","T234","T235","T236","T24","T240","T241","T242","T244","T245","T246","T25","T250","T251","T252","T254","T255","T256","T29","T290","T291","T292","T294","T295","T296","T30","T300","T301","T302","T304","T305","T306","T31","T310","T311","T32","T320","T321","T95","T950","T951","T952","T953","T954","T958","T959"),collapse = "|")

dt$burn_cts <- if_else(str_detect(allinj,burn_face),"Red",
                    if_else(str_detect(allinj,burn_internal_inj),"Orange",   if_else(str_detect(allinj,burn_rest),"Yellow","Green")))

# Injury

injury_type <- dt$inj_type

dt$injury_cts <- if_else(injury_type == "Dislocation","Orange",
                    if_else(injury_type == "Fracture","Yellow",
                            if_else(injury_type == "Crush Injury","Yellow",
                                    if_else(injury_type=="Amputation","Yellow","Green"))))

# uniting all cts

dt <- suppressWarnings(suppressMessages(unite(dt, allcts, contains("cts"), sep = ",", remove = FALSE)))

allcts <- dt$allcts

dt$triage <- if_else(str_detect(allcts,"Red"),"Red",
                     if_else(str_detect(allcts,"Orange"),"Orange",
                             if_else(str_detect(allcts,"Yellow"),"Yellow",
                                     "Green")))
table(dt$triage)


# Created a dataframe of triage category green

kbbh <- subset(x=kbbh,subset = kbbh$tc == 0)

# creating inclusion flow chart
grViz("digraph flowchart {
      # node definitions with substituted label text
      node [fontname = Helvetica, shape = rectangle]        
      tab1 [label = 'Total patients in TTRIS n=15000']
      tab2 [label = 'Patients in other centre n=10207']
      tab3 [label = 'Patients in KBBH n=4793']
      tab4 [label = 'Excluded : \n Records with incomplete observations n=228 \n Patients that did not consent for follow-up n=411']
      tab5 [label = 'Included: n=4151']
      tab6 [label = 'Patients Triaged green in KBBH dataset n=4135', shape = oval]

      # edge definitions with the node IDs
      tab1 -> tab2; 
      tab1 -> tab3
      tab3 -> tab4;
      tab3 -> tab5
      tab5 -> tab6
      }
      ") %>% export_svg %>% charToRaw %>% rsvg_svg("flowchart.svg")

```

```{r result, warning=FALSE, message=FALSE}

tr <- subset(x=kbbh, subset = kbbh$tran == 1)
table((subset(x=tr, subset = tr$admits == "Not admitted"))$hd)

dr <- subset(x=kbbh, subset = kbbh$tran == 0)
table((subset(x=dr, subset = dr$admits == "Not admitted"))$hd)

ad <- subset(x=kbbh,subset = kbbh$admits == "Admitted")
x <- subset(x=ad,subset = ad$s != "0" & ad$s != "888")

view(subset(x=ad, subset = ad$daicu != "0"))
# Number of records
dm <- as.numeric(nrow(kbbh))

calculate_n_p <- function(level.name, factor.var){
    assert_that(is.character(level.name))
    assert_that(is.factor(factor.var))
    nm <- sum(factor.var == level.name)
    percent <- round((nm/dm) * 100,1)
    return.list <-list(nm = nm, percent = percent)
    return.list
}

# Transfer status
tran.data <- list.sort(lapply(setNames(nm = levels(kbbh$tran)), calculate_n_p, factor.var = kbbh$tran), nm, decreasing = TRUE)
tranv <- unlist(tran.data)

nm_direct <- tranv["Direct.nm"]
p_direct <- tranv["Direct.percent"]
nm_tran <- tranv["Transferred.nm"]
p_tran <- tranv["Transferred.percent"]

# Age
mean_age <- round(mean(kbbh$age),0)
stddev_age <- round(sd(kbbh$age),0)

nm_age <- sum(kbbh$agegrp != "65+")
percent_agebelow65 <- round(mean(kbbh$agegrp != "65+") * 100, 1)

# Sex
sex.data <- list.sort(lapply(setNames(nm = levels(kbbh$sex)), calculate_n_p, factor.var = kbbh$sex), nm, decreasing = TRUE)

sexv <- unlist(sex.data)
nm_male <- sexv["Male.nm"]
p_male <- sexv["Male.percent"]
nm_female <- sexv["Female.nm"]
p_female <- sexv["Female.percent"]

# Type of Injury

tyi.data <- list.sort(lapply(setNames(nm = levels(kbbh$tyi)), calculate_n_p, factor.var = kbbh$tyi), nm, decreasing = TRUE)

tyiv <- unlist(tyi.data)
nm_blunt <- tyiv["Blunt.nm"]
p_blunt <- tyiv["Blunt.percent"]

nm_pene <- tyiv["Penetrating.nm"]
p_pene <- tyiv["Penetrating.percent"]

# Mode of Transport
mot.data <- list.sort(lapply(setNames(nm = levels(kbbh$mot)), calculate_n_p, factor.var = kbbh$mot), nm, decreasing = TRUE)

motv <- unlist(mot.data)
nm_pvt <- motv["Private Vehicle.nm"]
p_pvt <- motv["Private Vehicle.percent"]
nm_onfoot <- motv["On foot.nm"]
p_onfoot <- motv["On foot.percent"]
mot1 <- names(mot.data[1])
mot2 <- names(mot.data[2])

# MOI
moi.data <- list.sort(lapply(setNames(nm = levels(kbbh$moi.collapsed)), calculate_n_p, factor.var = kbbh$moi.collapsed), nm, decreasing = TRUE)

moiv <- unlist(moi.data)
p_animalbite <- moiv["Animal bite.percent"]
p_assault <- moiv["Assault.percent"]
p_fall <- moiv["Fall.percent"]
p_other <- moiv["Other.percent"]
p_tra <- moiv["Transport accident.percent"]

moi1 <- names(moi.data[1])
moi2 <- names(moi.data[2])
moi3 <- names(moi.data[3])

# ISS 
iss.data <- list.sort(lapply(setNames(nm = levels(kbbh$isspv)), calculate_n_p, factor.var = kbbh$isspv), nm, decreasing = TRUE)

issv <- unlist(iss.data)
nm_iss_mild <- issv["Mild.nm"]
p_iss_mild <- issv["Mild.percent"]
nm_iss_nd <- issv["No defined injury.nm"]
p_iss_nd <- issv["No defined injury.percent"]
nm_iss_mod <- issv["Moderate.nm"]
p_iss_mod <- issv["Moderate.percent"]

# Outcome
kbbh$s30d <- as.factor(kbbh$s30d)
outcome.data <- lapply(setNames(nm = levels(kbbh$s30d)), calculate_n_p, factor.var = kbbh$s30d)
p_outcome_alive <- outcome.data[["0"]]["percent"]
p_outcome_dead <- outcome.data[["1"]]["percent"]
n_outcome_dead <- outcome.data[["1"]]["nm"]

p_followup <- as.numeric(p_outcome_alive)+as.numeric(p_outcome_dead)

# injury type

kbbh$inj_type <- as.factor(kbbh$inj_type)

inj.data <- list.sort(lapply(setNames(nm = levels(kbbh$inj_type)), calculate_n_p, factor.var = kbbh$inj_type), nm, decreasing = TRUE)

injv <- unlist(inj.data)
p_supf <- injv["Superficial Injury.percent"]
nm_supf <- injv["Superficial Injury.nm"]
p_ndi <- injv["No defined Injury.percent"]
nm_ndi <- injv["No defined Injury.nm"]
p_ow <- injv["Open Wound.percent"]
nm_ow <- injv["Open Wound.nm"]
p_frac <- injv["Fracture.percent"]
nm_frac <- injv["Fracture.nm"]
inj1 <- names(inj.data[1])
inj2 <- names(inj.data[2])
inj3 <- names(inj.data[3])
inj4 <- names(inj.data[4])

amp <- subset(x=kbbh, subset = kbbh$inj_type == "Amputation")


# Injury characteristics of transferred to kbbh patients
tr <- subset(x=kbbh, subset = kbbh$tran == "Transferred")

tr.inj.data <- list.sort(lapply(setNames(nm = levels(tr$inj_type)), calculate_n_p, factor.var = tr$inj_type), nm, decreasing = TRUE)

tr.inj.v <- unlist(tr.inj.data)

nm_tr_superf <- tr.inj.v["Superficial Injury.nm"]
nm_tr_nd <- tr.inj.v["No defined Injury.nm"]
nm_tr_frac <- tr.inj.v["Fracture.nm"]
nm_tr_ow <- tr.inj.v["Open Wound.nm"]

injvmoi <- as_tibble(colPerc(xtabs(~kbbh$inj_type+kbbh$moi.collapsed, data = kbbh)))

assault_sup.p <- injvmoi[["Assault"]][11]
assault_noinj.p <- injvmoi[["Assault"]][8]
assault_ow.p <- injvmoi[["Assault"]][9]
assault_total.p <- assault_noinj.p+assault_ow.p+assault_sup.p

tr_sup.p <- injvmoi[["Transport accident"]][11]
tr_noinj.p <- injvmoi[["Transport accident"]][8]
tr_ow.p <- injvmoi[["Transport accident"]][9]
tr_frac.p <- injvmoi[["Transport accident"]][6]
tr_total.p <- tr_noinj.p+tr_ow.p+tr_sup.p

fall_sup.p <- injvmoi[["Fall"]][11]
fall_noinj.p <- injvmoi[["Fall"]][8]
fall_ow.p <- injvmoi[["Fall"]][9]
fall_frac.p <- injvmoi[["Fall"]][6]
fall_total.p <- fall_noinj.p+fall_ow.p+fall_sup.p

ab_sup.p <- injvmoi[["Animal bite"]][11]
ab_noinj.p <- injvmoi[["Animal bite"]][8]
ab_ow.p <- injvmoi[["Animal bite"]][9]
ab_total.p <- ab_noinj.p+ab_ow.p+ab_sup.p

```

```{r conclusion}
p_iss_nd <- round(mean(kbbh$isspv == "ND") * 100,1)
p_iss_mi <- round(mean(kbbh$isspv == "Minor") * 100,1)
p_rts_8 <- round(mean(kbbh$rts == 8) * 100,1)

```
# Abstract

## Introduction

Trauma is one of the leading causes of emergency department visits.  Based on injury severity and physiological parameters patients are triaged as red, orange, yellow, or green, from most to least urgent. Emergency departments are perceived as quick and easy access to healthcare, leading to visits of patients with no injury or minor injuries. These patients with minor injuries, triaged green, consume significant resources. It is important to understand the characteristics of these patients to understand how they should be managed so that resources can be directed towards serious patients.

## Aim

The aim of this study is to describe the demographic, physiological and injury characteristics of trauma patients triaged green in the ED of a secondary care hospital in Mumbai.

## Methods

We performed this single-centre prospective cohort study as part of the Trauma Triage Study in India (TTRIS). The TTRIS is a multicentre project, an extension of the Towards Improved Trauma Care Outcomes consortium.

## Results

During the study period, `r dm` patients from the TTRIS dataset were triaged green by the clinician and hence included in our study. Of these, `r nm_tran` were transferred from other healthcare facilities and approximately `r p_pvt`% of patients from our study population arrived through `r mot1`, `r p_onfoot`% `r mot2`, with the least number of people using the ambulance as a mode of transport to the ED

## Conclusion

Among the patients triaged green, injury due to assualt and transport accidents were predominant. All patients had an RTS score of greater than four. Most of the patients had minor injuries or no defined injuries.

---------------------------------------------------------------------------

# Introduction
Emergency departments are meant to cater to patients that require immediate care. Trauma is one of the leading causes of emergency department (ED) visits.[@weiss2014]
In the ED, patients are sorted for treatment by priority using triage. There are different triage systems applied in ED across the world like the Australian triage system (ATS), the canadian Triage and Acuity Scale (CTAS), the Manchester Triaging system (MTS) and the Emergency Severity Index (ESI).[@christ2010modern] These use an estimate of injury severity and physiological parameters to triage, prioritize for treatment, patients as red, orange, yellow, or green, from most to least urgent. Studies have categorised patients triaged (according to the MTS) green and blue as not very urgent and non-urgent respecticely.[@moura2020],[@slagman2019].

Most often EDs are perceived to provide quick and easy access to healthcare. This leads to visits of patients with no injury or minor injuries.[@Uscher-Pines2013],[@Coster2017]. These are non-urgent visits or ones that do not require an ED visit. 
Although these patients are triaged green they consume significant resources in the form of time, man-power. This also leads to poor patient outcome and impacts waiting times of patients having more urgent needs as an effect of overcrowding.[@morley2018] In India, no objective data is available to understand the problem of overcrowding.

It is important to understand the characteristics of these patients to understand how they should be managed so that resources can be directed towards serious patients.
The aim of this study is to describe the demographic, physiological and injury characteristics of trauma patients triaged green in the ED of a secondary healthcare hospital in Mumbai.

# Methods

## Study Design 

We performed this single-centre prospective cohort study as part of the Trauma Triage Study in India (TTRIS). The TTRIS is a multicentre project, an extension of the Towards Improved Trauma Care Outcomes consortium.

## Study Setting

We conducted this study in the emergency department (ED) at the Khershedji Behramji Bhabha Hospital (KBBH) between July 2016 to November 2019. KBBH is a 436 bedded regional secondary healthcare facility located in Mumbai, India, catering to approximately 350 patients each day in the ED, with trauma as a subspeciality with  medical, surgical and obstetric emergencies.. There are surgery, orthopaedics and anaesthesia departments and both adult and paediatric intensive care units. There is no neurosurgery department in KBBH. Most patients present directly and were not transferred from another health centre. Plain radiography  and ultrasonography are available around the clock, but CT is only available in-house during the day. During evenings and nights, patients in need of a CT or neurosurgeon's opinion are referred to nearby tertiary care centres. Prehospital care in India is poorly developed, with no organised emergency medical services and the concept of onscene triage in trauma patients is non-existent. Ambulances are predominately used for interhospital transfers, and most patients who arrive directly from the scene of the incident arrive in private vehicles or on-foot. The patients arriving at the ED are first seen by a casualty medical officer largely on a first come, first served basis. There is no formalised system for triaging ED patients at KBBH. 

## Clinician Triage						

For the purpose of this study, the clinicians who first assessed the patients on arrival to the ED were asked by the project officers to categorise patients into four colour-coded triage level groups, henceforth referred to as only triage levels. The triage levels were green, yellow, orange and red. The risk of mortality increases from green to red along the corresponding colour spectrum, with green and red indicating the least and most urgent patients, respectively. The clinicians were allowed to use all information available at the time when they assigned the triage level, which was as soon as they had first seen the patient. The triage levels were not used to guide further patient care, and no interventions were implemented as part of the study for patients assigned to the more urgent triage levels. 

## Participants

- Inclusion Criteria: We included any person aged ≥18 years presenting to the KBBH ED with a history of trauma. A history of trauma was defined here as having any of the external causes of morbidity and mortality listed in block V01-Y36, chapter XX of the International Classification of Disease version 10 online code book as the primary complaint, with some exclusions (see online supplementary material).	

## Source and methods of selection of participants and follow-up

Data of patients that visited the ED was collected for TTRIS at KBBH Mumbai, Institute of Post Graduate Medical Education and Research and Seth Sukhlal Karnani Memorial Hospital (IPGMER and SSKM), Kolkata and Maulana Azad Medical College (MAMC), Delhi , during July 2016- November 2019. The project officer (the primary author of this manuscript) worked morning, evening and night shifts (6 hour observational shifts) and data were collected from the first 10 consecutive patients only, irrespective of their triage, during each shift. Data collected at KKBH, Mumbai was extracted and evaluated for this study.

![](flowchart.svg)

The rationale for including only the first 10 patients was that this was the number of participants that we considered feasible to follow-up. Follow-up was performed by the project officer at 24 hours, 30 days and 6 months after a participant arrived at the ED. The time frame of the study was chosen to ensure that all included patients had completed 6 months of follow-up to minimise the loss to follow-up. The follow-up was completed in person or by phone, depending on whether the patient was still hospitalised or if the patient had been discharged. The phone numbers of one or more contact persons, for example, relatives, were collected on enrolment and those people were contacted if the participant did not reply to the follow-up phone call. Only if neither the participant nor the contact person answered any of three phone calls was the outcome recorded as missing. 

## Variables and Outcomes

- Outcomes 		 	 	 							
The outcome variable was mortality within 30 days and 6 months, henceforth referred to as 30-day and 6-month mortality. 

- Clinician Triage						
For the purpose of this study, the clinicians who first assessed the patients on arrival to the ED were instructed by the project officers to categorise patients into four colour-coded triage level groups, henceforth referred to as only triage levels. The triage levels were green, yellow, orange and red. The risk of mortality increases from green to red along the corresponding colour spectrum, with green and red indicating the least and most urgent patients, respectively. The clinicians were allowed to use all information available at the time when they assigned the triage level, which was as soon as they had first seen the patient. The triage levels were not used to guide further patient care, and no interventions were implemented as part of the study for patients assigned to the more urgent triage levels. 

## Variables

- Mechanism of Injury: This dataset contains patients presenting to the ED with any of the mechanisms of Injury listed in International Classification of Diseases (ICD-10) between V01 to Y09. Mechanism of injury (ICD-10) codes were grouped into Transport accidents (V00-V99), Falls (W00-W19), Animal Bites (W50-W64), Assault (X85-X99, Y00-Y09) and others.

- The number of serious injuries was estimated by the treating physician. A serious injury here was defined as injury that warrants hospitalization.

Severity of Injury was assessed using ISS and RTS scores and further elaborated by identifying injury characteristics

- Injury characteristics: Injuries were recorded and coded using the ICD-10 in the TTRIS dataset. To further understand the characteristics of the injury and analyse its severity, patients were divided into categories with respect to the most critical injury (using the ICD-10 codes) into namely; Crush injury, Injury to internal organs, blood vessel injury, Amputation, Fracture, Dislocation, Burn, Multiple injury, Unspecified Injury, Open wound, Superficial Injury and No defined injury.10 If no crush injury was present then the patient was categorized into the next most critical injury. Injury characteristics of patients that presented to the ED with no injuries were categorized as ‘No defined injury’

- The Injury Severity Score (ISS): ISS was categorized , ‘mild’ (3-8), ‘moderate’ (9-15), ‘severe’ (16-25), ‘profound’ (>25). ISS was not assigned to patients with ‘no defined injuries’.

- Revised Trauma Score (RTS): RTS was calculated using the GCS, RR and SBP values in the TTRIS dataset. They were further categorized into RTS < 4 and RTS > 4.

## Quality assurance

There were several layers of quality control. First, data were entered using a dedicated electronic data collection instrument with extensive logical checks and prompts for unlikely but possible values. Second, the collected data were reviewed on a weekly basis and discussed during weekly online conferences with all project officers. Third, on-site quality control sessions were conducted every 3–4 months. During these sessions, a second project officer collected data alongside the project officer who worked at the ED. The quality control data were then compared with the standard data. 

## Data Analysis 

Data analysis was performed using R statistical software. Complete case analysis for performed and incomplete patient records were excluded. Descriptive statistics was run for all variables. The results are presented as number and percentages for categorical variables and mean and standard deviation for quantitative variables. The Chi-square test was performed to understand the association between age groups and injury characteristic with a confidence interval of 95%

# Results

During the study period, `r dm` patients from the TTRIS dataset were triaged green by the clinician and hence included in our study. Of these, `r nm_tran` were transferred from other healthcare facilities and approximately `r p_pvt`% of patients from our study population arrived through `r mot1`, `r p_onfoot`% `r mot2`, with the least number of people using the ambulance as a mode of transport to the ED

_Patient Demographics_

The mean age of patients was `r mean_age` (+-`r stddev_age`), with 49.4% in the age group of 25 to 44 years. A large proportion of patients (`r percent_agebelow65`%) were below 65 years of age which mainly constitutes the working population. A total of `r nm_male` (`r p_male`%) patients were male. 

_Patients Injuries_

We observed `r moi1` as the commonest cause of injury (`r p_tra`%) followed by `r moi2` (`r p_assault`%) and `r moi3` (`r p_fall`%) with injury due to animal bites in `r p_animalbite`% of the patients. Blunt injuries represented the most common type of injury endured by patients (`r p_blunt`%) followed by penetrating injuries (`r p_pene`%). Of the `r nm_tran` patients  transfered from other hospitals or local clinics, `r nm_tr_superf + nm_tr_nd` had superficial injuries (`r nm_supf`) or no defined injuries (`r nm_tr_nd`), `r nm_tr_frac` had fracture, `r nm_tr_ow` had open wound.

The Injury Severity Score (ISS) indicated that `r p_iss_mild`% were 'mild', `r p_iss_nd`% patients had 'No defined injuries', the remaining `r p_iss_mod`% `r (nm_iss_mod)` patients had 'moderate' severity. 
All patients had RTS greater than four, with `r p_rts_8`% having a score of greater than eight. 

Most common type of amputations were, a single finger (8), thumb (2) and single toe amputations (2). Crush injuries were of unspecified part of the hand (3) the finger (1) and the toe (2). More than one third of the fractures were forearm and elbow fractures (58), followed by hand (51), foot fracture (46) and knee or lower leg fracture (30). Shoulder or upper arm fracture were 22, hip and thigh fractures were 18 and fracture of skull or facial bones were 14.

A chi-square test was performed to investigate the association between type of injury and age with confidence interval of 95%. The proportion of patients having different injury types differed by age (p<.001).Patients in the age group of 24-44 constituted approximately 50% of all injuries.

_Patient Outcomes_

Follow up at 30 days was successful for `r p_followup`% patients, of which two patients, aged 80 years old, and one patient aged 60 years old were reported dead. 

First patient (aged 80) arrived in the ED 7 days after injury due to fall on the same level from slipping, tripping or stumbling (W01). The patient was inaccurately triaged green as she had a GCS of 7 (2 - EGCS, 2 - VGCS, 3 - MGCS) on arrival and was admitted in the ICU with an ED - LOS of 30 minutes. Documented injury of the patient was an old contused lacerated wound (CLW) on the forehead and abrasion on arm. The patient died within 36 hours of admission. 

Another patient (aged 60) was inaccurately triaged as he had a GCS of 8 (2 - EGCS, 4 - VGCS, 2 - MGCS). The patient arrived at the ED within 45 mins of injury due to fall  from, out of or through building or structure (W13). The patient was transferred to a higher centre with a ED-LOS of 1 hour 50 minutes. The patient was alive at 24hrs follow-up but was reported dead at 30days follow-up. The cause of death can not be deduced with the available data. 

The third patient arrived in the ED within an hour following injury due to fall (W18) with a complaint of pain in the hip. On arrival, the patient had a GCS of 15 and oxygen saturation of 98. The radiological findings (X-Ray Chest and X-Ray Pelvis and both hips (PBH)) were normal, therefore he was discharged from the ED with an ED - LOS of less than 3 hours. We were unable to ascertain the cause of death and presumed this patient must to have died due to old age and natural causes. 

```{r}
#Factor labels
kbbh$sex <- factor(kbbh$sex, levels = c(0,1), labels = c("Female","Male"))
kbbh$tyi <- factor(kbbh$tyi, levels = c(0,1,2), 
                   labels = c("Blunt","Penetrating","Blunt & penetrating"))
kbbh$mot <- factor(kbbh$mot, levels = c(0,1,2,3), 
                   labels = c("Ambulance","Police","Private Vehicle","On foot"))
kbbh$tran <- factor(kbbh$tran, levels = c(0,1), 
                    labels = c("Direct","Transferred"))
kbbh$avpu <- factor(kbbh$avpu, levels = c(0,1,2,3), 
                    labels = c("Unresponsive","Pain","Verbal","Alert"))
kbbh$vo2 <- factor(kbbh$vo2, levels = c(0,1), 
                   labels = c("Not on oxygen support","On oxygen support"))
kbbh$nsi <- factor(kbbh$nsi, levels = c(0,1,2), 
                   labels = c("No serious injury","Single","Multiple"))
kbbh$hd <- factor(kbbh$hd, levels = c(0,1,2,3), 
                  labels = c("Discharged","Dead","Transferred","Abscond/ DAMA"))

var_label(kbbh) <- list(age = "Age", agegrp = "Age Group", sex = "Sex", moi.collapsed = "Mode of Injury", tyi = "Type of injury", mot = "Mode of transport", tran = "Transfer status", avpu = "AVPU", sbp = "Systolic blood pressure", dbp = "Distolic blood pressure", hr = "Heart rate", spo2 = "Oxygen saturation", vo2 = "Need for oxygen support", rr = "Respiratory rate", nsi = "Number of serious injuries", hd = "Hospital disposition", gcs = "GCS", gcs.cat = "GCS",isspv = "ISS", rts = "RTS", inj_type = "Characteristic of Injury", admits = "Admit status")

myvars <- c("age", "mot", "tran", "avpu", "sbp", "dbp", "hr", "spo2", "vo2", "rr", "nsi", "hd", "gcs","gcs.cat", "isspv", "rts","inj_type")

catvars <- c("mot", "tran", "avpu", "vo2", "nsi", "hd","gcs.cat", "inj_type")

Table1 <- CreateTableOne(vars = myvars, strata = "admits", data=kbbh, factorVars = catvars)
knitr::kable(print(Table1,
                   caption = "Table 1. Demographic, Physiological parameters, Injury Characteristics", showAllLevels = TRUE, printToggle = FALSE, varLabels = TRUE))
```

Table2 shows, Among patients with animal bites, 67.36% had no defined injuries while 32.64% had 'minor' severity. Of fall, 63.85% patients had no defined injuries while 34.96 had 'minor' severity The mechanism of injury of patients with moderate injuries were Fall, Assualt and others.Patients with ISS severe were not present.

shows Characteristics of the patient injury were most commonly `r inj1` (`r p_supf`%), followed by `r inj2` (`r p_ndi`%), `r inj3` (`r p_ow`%) that required suturing and `r inj4` (`r p_frac`%). Characteristic of injuries in Table 3 shows,  90.5% patients with animal bites had superficial injuries, while 6.75% and 2.34% had no defined injuries and open wounds respectively. In patients with assault, 42.18% had superficial injuries followed by no defined injuries in 30.68% patients and 24.48% patients having open wound injuries. Most cases of fracture were found in patients with fall followed by Transport accidents.

```{r}
Table3 <- round(colPerc(xtabs(~kbbh$inj_type+kbbh$moi.collapsed, data = kbbh)),0)
kable(Table3,
      caption = "Percentage distribution of Injury type among different Mechanism of Injury",
)
```

```{r}

# Pearson's Chi-squared test
# data:  nap$inj_type and nap$ardd
# X-squared = 500.47, df = 20, p-value < 2.2e-16

```


A chi-square test was performed to investigate the association between type of injury and age with confidence interval of 95%. The proportion of patients having different injury types differed by age (p<.001).Patients in the age group of 24-44 constituted approximately 50% of all injuries.

```{r}

#Chi-square test

## null hypothesis: The proportion of injury types do not differ across the age groups

cstageg <- table(kbbh$agegrp,kbbh$inj_type)

#	Pearson's Chi-squared test
# data:  kbbh$agegrp and kbbh$inj_type
# X-squared = 80.859, df = 30, p-value = 1.486e-06

## We reject the null hypothesis 
## The proportion of injury types does differ across the age groups

Table5 <- round(rowPerc(xtabs(~kbbh$inj_type+kbbh$agegrp, data = kbbh)),0)
kable(Table5,
      caption = "Proportion of patients with different injury types w.r.t their age group",
)

# data:  injar.time and kbbh$inj_type
# X-squared = 265.86, df = 220, p-value = 0.01868

```

# Conclusion


# References


